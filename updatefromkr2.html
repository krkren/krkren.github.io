<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>KiriKiri Z / List of Changes from KiriKiri 2 in KiriKiri Z</title>
<link rel="stylesheet" href="styles-site.css" type="text/css" />
</head>
<body>
<a name="top"></a>
<div id="top_link"><a href="./index.html">To Top</a></div>
<div id="container">
<div id="title-banner"><h1>List of Changes from KiriKiri 2 in KiriKiri Z</h1></div>

<div class="content">
<p>
The following changes are regarding the initial official release.<br />
There is a possibility that further changes have been added in subsequent versions.<br />
For updates after 1.0, please refer to the <a href="./olderversions.html">Update History</a>.<br />
</p>
<br />
<div class="title_bar"><a name="update">Changes</a></div>
<ol>
	<li>Modified to allow building with Visual Studio.</li>
	<p>
		Various modifications were made so that KiriKiri 2, which was built with C++Builder 5, can be built with Visual C++ 2012.<br />
	</p>

	<li>Changed VCL-dependent parts to Win32 API calls.</li>
	<p>
		Since VCL cannot be used with VC, processing was changed to use standard Win32 API.<br />
		While the processing is somewhat equivalent, the implementation is not identical, so some details in behavior may differ.<br />
		In VCL, an invisible main window functions as the application (window), and other windows act as its children.<br />
		In KiriKiri 2, the first window created is treated as the main window, but an invisible application (window) exists internally (likely).<br />
		In KiriKiri Z, along with rewriting VCL, this invisible application (window) no longer exists.<br />
		Because of this, there are places where the application behavior differs in detail.<br />
		Among those treated as the application, several correspond to the main window within KiriKiri created first.<br />
		Application events like Active/Inactive now belong to the main window.<br />
	</p>

	<li>Changed Direct3D7 to Direct3D9.</li>
	<p>
		Things that were rendered with Direct3D7 have been rewritten to Direct3D9.<br />
		Along with this, the following changes were made.<br />
	</p>

	<li>Changed Fullscreen processing to be handled by DrawDevice.</li>
	<p>
		Fullscreening with DirectDraw seems to have caused several issues in Windows 8, so this part needed to be changed. In Direct3D9, the Direct3D Device handles fullscreening, so fullscreen processing was implemented on the DrawDevice side.<br />
		As mentioned above, with the transition to Direct3D9, fullscreening changed from API/DirectDraw to API/Direct3D9, and the setting is now dependent on DrawDevice rather than being an option.<br />
	</p>

	<li>Changed KAGParser class to a plugin.</li>
	<p>
		Since it was a class that was originally thought better as a plugin, it was moved to a plugin.<br />
		This plugin was created for compatibility.<br />
	</p>

	<li>Changed Menu class to a plugin.</li>
	<p>
		When deprecating Menu, it was moved to a plugin.<br />
		Implementation without using menus is recommended for the future.<br />
	</p>

	<li>Updated various dependency libraries.</li>
	<p>
		Updated to the latest versions at the time of VC project creation.<br />
	</p>

	<li> Changed the regular expression engine to Oniguruma.</li>
	<p>
		Since it was an older version of boost, it was changed to Oniguruma.<br />
	</p>

	<li> Changed console output to command-line output; also output to debug output during debugging.</li>
	<p>
		Along with the removal of the console, it was changed to output to the command line.<br />
		During debugging, it was also made to output to debug output because it makes debugging easier, so debug builds output to debug output as well.<br />
	</p>

	<li>Changed Font class so it can be instantiated.</li>
	<p>
		It only existed as Layer.font before, but it can now be created independently.<br />
	</p>

	<li>Specification change for tooltip processing.</li>
	<p>
		VCL tooltips were a proprietary implementation rather than common control tooltips. After considering whether to replace them with common controls or implement them similarly, they were changed to a form where events are generated and can be drawn as a Layer.<br />
		When Layer.hint is set and the cursor stops for a certain period reaching the hint display timing, the <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Window_onHintChanged.html">Window.onHintChanged</a> event occurs.<br />
		The cursor pause time can be specified with <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Window_hintDelay.html">Window.hintDelay</a>.<br />
		For layers that draw hints, enable <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Layer_ignoreHintSensing.html">Layer.ignoreHintSensing</a> to ignore hint sensing.<br />
		With this, when isshow is true in onHintChanged, you can draw the hint on the frontmost layer, and by setting the hint layer to ignore mouse messages, you can achieve a display similar to the conventional one.<br />
		If the event comes with isshow as false, hide it.<br />
		A <a href="https://github.com/jin1016/krkrz/blob/master/script/Sample/tooltip/startup.tjs">sample is available on GitHub</a>.<br />
	</p>

	<li>Made Gamepad enable/disable a debug option.</li>
	<p>
		Since there are cases where it's better not to have built-in gamepad support, it was made so it can be disabled via compile options as well as regular options.<br />
		Specifying DISABLE_EMBEDDED_GAME_PAD disables it.<br />
	</p>

	<li>Made using LLM the standard for JPEG decoding.</li>
	<p>
		In KiriKiri 2, AAN was used when quality was standard, but since AAN is low quality, LLM was made the standard.<br />
		In KiriKiri Z, JPEG loading is significantly faster than in KiriKiri 2. Even when changing the IDCT algorithm from AAN to LLM, it decodes faster than KiriKiri 2.<br />
		Since LLM is generally used, situations where images look "dirty" when displayed in KiriKiri should decrease.<br />
	</p>

	<li>Changed the default character code for TJS2 scripts to UTF-8.</li>
	<p>
		Changed from Shift-JIS because UTF-8 has become more common.<br />
		Compiling with TVP_TEXT_READ_ANSI_MBCS will make Shift-JIS the default as before.<br />
		Encoding can be specified in the 3rd argument of the public function TVPCreateTextStreamForReadByEncoding for plugins.<br />
		Specify either "Shift_JIS" or "UTF-8".<br />
		Also, the default can be changed by specifying either "Shift_JIS" or "UTF-8" with the "-readencoding" option.<br />
		Specification is also possible with <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Scripts_textEncoding.html">Scripts.textEncoding</a>.<br />
		The KAGParser plugin also follows this setting.<br />
		By changing the places where TVPCreateTextStreamForReadByEncoding is called in plugins, they can be read with any encoding.<br />
	</p>

	<li>Moved source code embedded strings to resources.</li>
	<p>
		Strings such as error messages that were directly described in the source code were moved to resources and separated into Japanese and English.<br />
		Since resources and source code are automatically generated from messages by script, it's easier to maintain for other environments.<br />
		They are described in Messages.xlsx and generated with entext.bat.<br />
		The license text is described in license.txt in the resources.<br />
	</p>

	<li>Moved options that were combined into the binary after compilation to resources.</li>
	<p>
		Changed the method of appending optionarea.bin to the end of tvpwin32.exe (as krkr.eXe) and reading the binary at the end during execution to embedding them in resources.<br />
		Options are described in optionarea.txt with line breaks.<br />
		Since this is a more common structure, it's expected to reduce false positives in antivirus software.<br />
	</p>

	<li>Changed screen size return values due to multi-display support.</li>
	<p>
		Previously, it always returned the values of the primary display, but it was changed to return values considering multiple displays.<br />
		<a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_System_screenWidth.html">System.screenWidth</a> / 
		<a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_System_screenHeight.html">screenHeight</a> return the size of the monitor where the main window is located. Before the main window is created, it returns the size of the primary monitor.<br />
		<a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_System_desktopLeft.html">System.desktopLeft</a> / 
		<a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_System_desktopTop.html">desktopTop</a> / 
		<a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_System_desktopWidth.html">desktopWidth</a> / 
		<a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_System_desktopHeight.html">desktopHeight</a> return the working area of the monitor where the main window is located. When there is no main window, it returns the working area of the primary monitor.<br />
	</p>


	<li>Scripted the font selection dialog.</li>
	<p>
		Removed from the core and changed to an implementation using win32dialog.dll + scripts.<br />
		Scripts are on <a href="https://github.com/krkrz/krkrz/tree/master/script/Krkr2Compat">GitHub</a>.<br />

	</p>

	<li>Scripted the character input dialog.</li>
	<p>
		Removed from the core and changed to an implementation using win32dialog.dll + scripts.<br />
		Scripts are on <a href="https://github.com/krkrz/krkrz/tree/master/script/Krkr2Compat">GitHub</a>.<br />
	</p>


	<li>Changed startup file selection dialog to folder selection dialog.</li>
	<p>
		Changed what was a proprietary dialog using VCL to a folder selection dialog.<br />
	</p>

	<li>Made it possible to disable startup file selection via debug option.</li>
	<p>
		Since it's a feature better not to have in the final release version, it was made possible to disable.<br />
		Defining TVP_DISABLE_SELECT_XP3_OR_FOLDER disables it.<br />
	</p>

	<li>Changed from Multi-byte code to Wide (UNICODE) byte code.</li>
	<p>
		Since only NT-based systems are supported, it was changed to Wide (UNICODE) byte code.<br />
	</p>

	<li>Property conversion of -waitvsync.</li>
	<p>
		The command-line option -waitvsync was deprecated and changed to <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Window_waitVSync.html">Window.waitVSync</a>.<br />
		This is because each window has a D3DDevice, and vertical sync wait depends on that device.<br />
	</p>

	<li>Changed to PassThroughDrawDevice and BasicDrawDevice.</li>
	<p>
		Deprecated PassThroughDrawDevice, which benchmarked DirectDraw / Direct3D / GDI and performed rendering with one of them, and added BasicDrawDevice, which performs rendering with Direct3D9.<br />
		BasicDrawDevice is the standard for DrawDevice.<br />
		If you want to render with something other than Direct3D9, additions via plugins are required.<br />
	</p>

	<li>JSON-ized option descriptions and moved them to resources.</li>
	<p>
		Changed the option description file, which was in a proprietary format, to JSON.<br />
		Also moved the file to resources, and changed reading from plugins from a public function to resources.<br />
		Specification is possible in option_desc_ja.json.<br />
		When started with -userconf, setting items are displayed according to this file.<br />
	</p>

	<li>Supported XP3 files exceeding 2GB.</li>
	<p>
		Fixed an issue in KiriKiri 2 where errors occurred during loading, allowing XP3 files over 2GB to be read.<br />
	</p>

	<li>Removal of Window regeneration.</li>
	<p>
		In KiriKiri 2, the window was recreated when changing to fullscreen or changing border styles, but in KiriKiri Z, recreation no longer occurs.<br />
		Because of this, opportunities for TVP_WM_DETACH and TVP_WM_ATTACH to be called are almost gone.<br />
		To know the timing of fullscreening/windowing, TVP_WM_FULLSCREEN_CHANGING is called before the change, and TVP_WM_FULLSCREEN_CHANGED is called after the change. (Note that these are not for determining if it is currently fullscreen).<br />
	</p>

	<li>Increase/Decrease of plugin public functions.</li>
	<p>
		The following public functions were added:<br />
		TVPCreateTextStreamForReadByEncoding<br />
		TVPSetDefaultReadEncoding<br />
		TVPGetDefaultReadEncoding<br />
		TVPRegisterAcceleratorKey<br />
		TVPUnregisterAcceleratorKey<br />
		TVPDeleteAcceleratorKeyTable<br />
		TVPEnsureDirect3DObject<br />
		TVPGetDirect3DObjectNoAddRef<br />
		TVPChBlurMulCopy<br />
		TVPChBlurAddMulCopy<br />
		TVPChBlurCopy<br />
		<br />
		The following public functions were removed:<br />
		TVPMIDIOutData<br />
		TVPEnsureDirectDrawObject<br />
		TVPGetDirectDrawObjectNoAddRef<br />
		TVPGetDirectDraw7ObjectNoAddRef<br />
		TVPGetDDPrimarySurfaceNoAddRef<br />
		TVPSetDDPrimaryClipper<br />
		TVPReleaseDDPrimarySurface<br />
	</p>
</ol>


<div class="title_bar"><a name="delete">Deletions</a></div>
<ol>
	<li>Removal of Console</li>
	<p>
		Removed because it is better not to be included in the final release.<br />
	</p>

	<li>Removal of Controller</li>
	<p>
		Removed because it is better not to be included in the final release.<br />
	</p>

	<li>Removal of MIDI / CDDA / Pad classes</li>
	<p>
		Removed based on the judgment that these are legacy features considering the current situation.<br />
	</p>

	<li>Removal of Win9X-related methods</li>
	<p>
		Since only XP and later are supported, APIs for supporting previous versions were removed.<br />
	</p>

	<li>Removal of DirectDraw rendering processing</li>
	<p>
		Removed because DirectDraw support in drivers has become unreliable and it is an old API.<br />
	</p>

	<li>Removal of ERI format support</li>
	<p>
		Removed because no particular significance is found for its use in the current situation.<br />
	</p>

	<li>Removal of several Window class methods.</li>
	<p>
		The removed methods/properties are as follows:<br />
		Window.layerLeft / Window.layerTop / Window.setLayerPos<br />
		Window.innerSunken<br />
		Window.showScrollBars<br />
		Window.beginMove<br />
	</p>
	<li>Removal of obsolete Layer class methods.</li>
	<p>
		Removed because they were already obsolete and replacement with newer methods had been recommended.<br />
		The removed methods are as follows:<br />
		Layer.affineBlend<br />
		Layer.affinePile<br />
		Layer.blendRect<br />
		Layer.pileRect<br />
		Layer.stretchBlend<br />
		Layer.stretchPile<br />
	</p>

	<li>Removal of mouse cursors not supported by standard Windows.</li>
	<p>
		Removed cursors that are standard in C++Builder but not in Windows.<br />
		The removed cursors are: crDrag, crNoDrop, crHSplit, crVSplit, crMultiDrag, crSQLWait, crAppStart, crHBeam.<br />
		If necessary, you must add resources yourself.<br />
		Also, other icons may look slightly different from C++ Builder.<br />
		<a href="http://krkrz.github.io/docs/kirikiriz/j/contents/MouseCursors.html">Click here for supported cursors</a> (images are still from KiriKiri 2).<br />
	</p>

	<li>Removal of krflash.dll</li>
	<p>
		krflash.dll is no longer bundled.<br />
		It might work if you use the one from KiriKiri 2, but it is not officially supported.<br />
		Migration to the flashPlayer plugin is recommended.<br />
	</p>
</ol>


<div class="title_bar"><a name="added">Additions</a></div>
<ol>
	<li>Support for multi-touch features.</li>
	<p>
		Touch becomes enabled if a device supporting multi-touch is active.<br />
		In cases where only one-point touch is supported, it is considered safe to treat it the same as mouse input, so touch is not enabled.<br />
		If you want to always handle input the same as a mouse instead of touch processing, you need to disable touch by setting <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Window_enableTouch.html">Window.enableTouch</a> to false.<br />
	</p>

	<li>Added Bitmap/ImageFunction/Rect classes.</li>
	<p>
		The Bitmap class was newly established based on requests for a class that only holds images, similar to the Layer class.<br />
		Along with that, ImageFunction and Rect classes were added to implement necessary features separated from Layer.<br />
	</p>

	<li>Added Octet.unpack and Array.pack.</li>
	<p>
		These are features that were planned for KiriKiri 2 but were seemingly not added.<br />
		This makes reading and writing binary files easier.<br />
		Refer to <a href="http://krkrz.github.io/docs/tjs2/j/contents/octet.html">Operations for Octet Strings</a> and 
		<a href="http://krkrz.github.io/docs/tjs2/j/contents/array.html">Array Class</a>.
	</p>

	<li>Possible to start from any script via -startup="xxx".</li>
	<p>
		Added because it is convenient for testing, etc.<br />
		Refer to <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/CommandLine.html">Command Line Options</a> for details.<br />
	</p>

	<li>Support for "Back" and "Forward" keys on 5-button mice.</li>
	<p>
		Added because they were introduced in Windows 2000 and later and are usable.<br />
		Can be used in <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Window_onMouseDown.html">Window.onMouseDown</a>, etc.<br />
	</p>

	<li>Support for background image loading features.</li>
	<p>
		Added because there was an issue where the display would stop during loading when updating images with conventional synchronous loading.<br />
		Asynchronous loading allows reading the next image without stopping display updates.
		Asynchronous loading is performed via <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Bitmap_loadAsync.html">Bitmap.loadAsync</a>.<br />
	</p>

	<li>TJS2 class inheritance can now be described in native (C++).</li>
	<p>
		Added because it is better to be able to describe TJS2 class inheritance in C++ as well.<br />
	</p>

	<li>Added drawGlyph to make drawing external characters easier.</li>
	<p>
		Added to make it easier to draw by embedding any glyph into a character string.<br />
		Can be drawn with <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Layer_drawGlyph.html">Layer.drawGlyph</a> / 
		<a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_ImageFunction_drawGlyph.html">ImageFunction.drawGlyph</a>.<br />
	</p>

	<li>Added PNG/JPEG/TLG save features.</li>
	<p>
		Since they can be read, saving features were added to correspond with that.<br />
		It has become convenient as reading and writing of BMP/PNG/JPEG/TLG is now possible in the core.<br />
		Format specification other than Bitmap is now possible with the type argument of <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Layer_saveLayerImage.html">Layer.saveLayerImage</a> / <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Bitmap_save.html">Bitmap.save</a>.<br />
	</p>
	
	<li>Added character rendering with FreeType.</li>
	<p>
		KiriKiri 2 only had character rendering by GDI, but rendering by FreeType is now also supported.<br />
		Can be specified with <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Font_rasterizer.html">Font.rasterizer</a>.<br />
		Cleaner character rendering than GDI can be expected.<br />
	</p>
	
	<li>Added log handlers.</li>
	<p>
		Added log handlers to make it possible to display logs via script.<br />
		Can be processed with <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Debug_addLoggingHandler.html">Debug.addLoggingHandler</a> / 
		<a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Debug_removeLoggingHandler.html">removeLoggingHandler</a> / 
		<a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Debug_getLastLog.html">getLastLog</a>.
	</p>
	
	<li>Added method to get actual character rendering range.</li>
	<p>
		Since it can be difficult to draw at a specified position cleanly depending on the font, a method to get the actual rendering range of a character string was added.<br />
		Can be obtained with <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Font_getGlyphDrawRect.html">Font.getGlyphDrawRect</a>.<br />
	</p>
	
	<li>Implementation of strikeout and underline.</li>
	<p>
		Implemented strikeout and underline, which were unimplemented in KiriKiri 2.<br />
		This allows drawing characters that include strikeouts or underlines.<br />
		Can be specified with <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Font_strikeout.html">Font.strikeout</a> / 
		<a href="http://krkrz.github.io/docs/kirikiriz/j/contents/f_Font_underline.html">underline</a>.<br />
	</p>

	<li>Support for Opus sound format.</li>
	<p>
		Supported the <a href="http://opus-codec.org/">Opus sound format</a>, which has a higher compression ratio than Vorbis, via kropus.dll.<br />
		Since the file size becomes small even for short sounds, it is also easy to use for sound effects.<br />
		Also, because it has compression methods optimized for voice, it is effective for dialogue, etc.<br />
	</p>

	<li>Bundled KiriKiri Debugger.</li>
	<p>
		Bundled the KiriKiri Debugger, which was previously distributed separately, and included binaries to enable the debugger.<br />
		TJS2 script debugging can now be performed more easily.<br />
	</p>

	<li>Added editor specification for script exception occurrence.</li>
	<p>
		Since the display using Pad upon exception occurrence was removed, it was made possible to specify any editor as a replacement.<br />
		Can be specified with -exceptionexe and -exceptionarg.<br />
		Refer to <a href="http://krkrz.github.io/docs/kirikiriz/j/contents/CommandLine.html">Command Line Options</a> for details.<br />

	</p>
</ol>


</div>
</div>
</body>
</html>