<html>
<head>
<meta HTTP-EQUIV="CONTENT-TYPE" CONTENT="TEXT/HTML; CHARSET=UTF-8">
<title>Kirikiri Z Functional Specification / Video Playback Function</title>
<link rel="stylesheet" href="styles-site.css" type="text/css" />
</head>
<body>
<a name="top"></a>
<div id="top_link"><a href="./index.html">To Top</a></div>
<div id="container">
<div id="title-banner">
<h1>Video Playback Function</h1>
</div>

<div class="content">
<p>Describes the video playback functions supported by Kirikiri Z.</p>
<h3>Table of Contents</h3>
<p><a href="#spec">Specifications</a><br />
<a href="#mode">Modes</a><br />
<a href="#trickplay">Special Playback Functions</a><br />
<a href="#preparevideo">About Video Playback Preparation ( preparevideo )</a><br />
<a href="#layermode">About Layer Specification in Layer Mode</a><br />
<a href="#end_of_video">Behavior at the End of Video</a><br />
<a href="#layer_alpha">Regarding the Phenomenon Where Video is Not Displayed in Layer Mode</a><br />
<a href="#mixer_mode">Mixing Playback</a><br />
<a href="#seek_to_keyframe">Keyframes and Seeking</a><br />

</p>
<br />

<div class="title_bar"><a name="spec">Specifications</a></div>
<br />
<table frame="box" rules="all">
	<tbody>
		<tr>
			<td rowspan="3">Mode</td>
			<td>Overlay Mode</td>
			<td>Mode that displays video using video overlay</td>
		</tr>
		<tr>
			<td>Layer Mode</td>
			<td>Mode that plays video on a layer within Kirikiri</td>
		</tr>
		<tr>
			<td>Mixer Mode</td>
			<td>Mode that displays video using VMR9 + Direct3D</td>
		</tr>

		<tr>
			<td rowspan="4">Special Playback Functions</td>
			<td>Segment Loop</td>
			<td>Function to loop between specified frames</td>
		</tr>
		<tr>
			<td>Period Event</td>
			<td>Function to trigger events at specified frames</td>
		</tr>
		<tr>
			<td>Playback Speed Specification</td>
			<td>Function to specify the playback speed of the video</td>
		</tr>
		<tr>
			<td>Multi-Audio</td>
			<td>Function to select and play one of the multiplexed audio streams</td>
		</tr>

		<tr>
			<td>Audio Balance<br />(Panning)</td>
			<td>-100000 to 0<br /> to 100000</td>
			<td>-100000 is completely left, 0 is center, 100000 is completely right.<br />
			When playing stereo sources, panning is achieved by<br />
			attenuating either the left or right channel.</td>
		</tr>
		<tr>
			<td>Audio Volume</td>
			<td>0 to 100000</td>
			<td>0 is complete mute, 100000 is 100% volume</td>
		</tr>
		<tr>
			<td>Audio Stream</td>
			<td>Content dependent</td>
			<td>Select the audio stream to play</td>
		</tr>
		<tr>
			<td>Playback Speed</td>
			<td>＞0</td>
			<td>The settable range depends on the DirectShow filter.<br />
			With audio: 2.0 ≥ speed ＞ 0.<br />
			1.0 is normal speed.</td>
		</tr>

		<tr>
			<td rowspan="7">Getable Values</td>
			<td>Frame Rate</td>
			<td>Number of frames per second</td>
		</tr>
		<tr>
			<td>Current Frame</td>
			<td>The frame currently being displayed.<br />
			There is no guarantee that it perfectly matches the displayed frame number.</td>
		</tr>
		<tr>
			<td>Current Playback Time</td>
			<td>Elapsed time within the video from the beginning.</td>
		</tr>
		<tr>
			<td>Image Size</td>
			<td>Width and height</td>
		</tr>
		<tr>
			<td>Number of Audio Streams</td>
			<td>Number of multiplexed audio streams</td>
		</tr>
		<tr>
			<td>Total Frames</td>
			<td>Total number of frames held by the video</td>
		</tr>
		<tr>
			<td>Total Time</td>
			<td>Total duration of the video</td>
		</tr>

		<tr>
			<td rowspan="4">Events</td>
			<td>Frame Update</td>
			<td>Occurs after a video frame is updated</td>
		</tr>
		<tr>
			<td>Period Event</td>
			<td>Occurs at normal loop ends, segment loop ends,<br />
			set period events, and when playback preparation is complete.</td>
		</tr>
		<tr>
			<td>Status Change</td>
			<td>Occurs when the playback state changes</td>
		</tr>

	</tbody>
</table>

<br />
<br />


<div class="title_bar"><a name="mode">Modes</a></div>
<br />
<table frame="box" rules="all">
	<thead><tr><td>Type</td><td>Description</td></tr></thead>
	<tbody>
		<tr>
			<td>Overlay Mode</td>
			<td>A mode that displays video using video overlay.<br />
			It is displayed in front of any other layers within Kirikiri.<br />
			In most cases, movie playback will be the lightest in this mode.<br />
			If you just want to play and stop a video, using Overlay Mode is recommended.<br />
			However, it has been reported that on some environments using Windows Vista and Windows XP when Kirikiri's drawing mode is DirectDraw, scaling in Overlay Mode does not look clean (jaggies occur).<br />
			For this reason, it is better to avoid Overlay Mode on Windows Vista.</td>
		</tr>
		<tr>
			<td>Layer Mode</td>
			<td>A mode that plays video on a specified layer within Kirikiri.<br />
			It has low environment dependency, and functions such as looping between specified frames (Segment Loop) and processing at specified frames (Period Event) are available.<br />
			However, it has the disadvantage of higher CPU load than other modes.<br />
			Also, scaling is not possible.</td>
		</tr>
		<tr>
			<td>Mixer Mode</td>
			<td>Added as an alternative to Overlay Mode, this mode displays video using VMR9 + Direct3D.<br />
			If the video card has video playback acceleration features and the codec supports it, it can be played using the video card's hardware acceleration.<br />
			The jaggy issue when scaling on Windows Vista is also avoided.<br />
			Additionally, mixing with specified layers and scaling are possible.<br />
			DirectX 9 or later is required to use this mode.</td>
		</tr>
	</tbody>
</table>

<br />
<br />

<div class="title_bar"><a name="trickplay">Special Playback Functions</a></div>
<br />
<table frame="box" rules="all">
	<thead><tr><td>Type</td><td>Description</td></tr></thead>
	<tbody>
		<tr>
			<td>Segment Loop</td>
			<td>A function that loops between specified frames.<br />
			To use this function, you must set a keyframe in the video file itself at the frame where the loop returns.<br />
			If there is no keyframe, it will not loop as expected.</td>
		</tr>
		<tr>
			<td>Period Event</td>
			<td>A function that can trigger an event at a specified frame to perform some processing.<br />
			By seeking to a distant frame when an event occurs, it is possible to skip intermediate frames and make the video look as if it is continuous.<br />
			Also, if you want to display subtitles synchronized with the video, you can achieve this by setting a period event at the starting frame of the subtitles and waiting for the event to display the text.<br />
			Additionally, using this function, you can play sounds using SE at specified frames without including audio in the video itself.</td>
		</tr>
		<tr>
			<td>Playback Speed Control</td>
			<td>The video playback speed can be specified.<br />
			Specifying 1.0 results in normal playback speed, 0.5 results in half speed, and 2 results in double speed.<br />
			The values that can be set depend on the DirectShow filter (Codec).</td>
		</tr>
		<tr>
			<td>Multi-Audio</td>
			<td>In MPEG I, multiple audio streams can be multiplexed, and this function utilizes that.<br />
			With this function, any audio stream can be played.<br />
			For example, you can prepare streams such as BGM only or BGM + Voice, allowing the user to specify which mode to play in.<br />
			However, because there is a time lag of about 2 seconds when switching audio streams, it is not very suitable for highly interactive purposes.<br />
			It can be used for purposes such as user selection or changing video audio depending on the scene as mentioned above.</td>
		</tr>

	</tbody>
</table>

<br />
<br />

<div class="title_bar"><a name="preparevideo">About Video Playback Preparation ( preparevideo )</a></div>
<p>preparevideo draws the first frame of the video onto the specified layer.<br />
This is used to prevent unintended images (memory garbage, previous images, etc.) from being displayed on the screen.<br />
In other words, by hiding the target layer, opening the video with openvideo, calling preparevideo, waiting for preparation with wp, and then making the target layer visible after preparation is complete, you can display the first frame of the video the moment it is shown.<br />
Note that this function is only meaningful in Layer Mode.<br />
</p>

<br />
<br />

<div class="title_bar"><a name="layermode">About Layer Specification in Layer Mode</a></div>
<p>When playing video in Layer Mode, use videolayer to specify the drawing target layer.<br />
In videolayer, you can specify slot, channel, page, and layer. <br />
The slot is equivalent to the buf in se, and is used to identify which video the operation is for when playing different videos simultaneously.<br />
Since it is unlikely that multiple videos will be played at the same time, it is usually fine to omit the description and let 0 be specified.<br />
The channel exists to specify the layer to output to.<br />
Up to two layers can be specified per video, so it is used to identify which of those two is being specified.<br />
The reason two can be specified is to utilize transitions.<br />
If a transition is executed while a video is playing, the front and back layers are swapped, so if it is only outputting to one side, the video will disappear.<br />
To avoid this, when performing a transition during video playback, set the front and back layers to channels 1 and 2. If you are not performing transitions, specifying only the front side is sufficient.<br />
</p>

<br />
<br />

<div class="title_bar"><a name="end_of_video">Behavior at the End of Video</a></div>
<p>If you play a video without specifying a loop, the video will stop once it plays to the end.<br />
If you want to proceed with the game while displaying the last frame of the video, this behavior is not ideal.<br />
The easiest way to avoid this is to use Layer Mode.<br />
In Layer Mode, since the video is drawn to a layer, the image of the last frame remains on the layer as is.<br />
Therefore, you can proceed with the game while displaying the last frame without any special consideration.<br />
In the case of Overlay or Mixer, the display disappears when stopped, so you must pause before reaching the final frame.<br />
This can be achieved with a period event, but since it might stop if it hits the absolute final frame, it is better to include a few dummy frames at the end of the video so that it's okay even if it overshoots slightly. <br />
</p>

<br />
<br />

<div class="title_bar"><a name="layer_alpha">Regarding the Phenomenon Where Video is Not Displayed in Layer Mode</a></div>
<p>If the display type of the layer targeted for video playback is set to alpha or similar, the video may not be displayed.<br />
This is because if the video does not have an alpha channel, undefined data is written to the alpha channel position.<br />
If the layer display type is set to alpha, this undefined data is treated as the alpha value, which can make it completely transparent.<br />
To avoid this, set the display type of the target layer to opaque.<br />
Doing so will make the video visible.<br />
However, since it is difficult to use opaque in KAG, calling freeimage instead seems to achieve a similar effect.<br />
</p>

<br />
<br />

<div class="title_bar"><a name="mixer_mode">Mixing Playback</a></div>
<p>As the name suggests, Mixer Mode allows you to mix and play video with other layers.<br />
Things that can be specified regarding mixing in Mixer Mode are background color, blend ratio, and target mixing layer.<br />
The target mixing layer mixes the video with the image at the moment it was set.<br />
Therefore, even if the target mixing layer is updated, the content will not be updated unless it is set again.<br />
However, calling the setting at every frame update will result in quite high CPU load.<br />
To keep CPU load down, it is better to limit settings to only when updates occur.<br />
The background color is the color blended when the blend ratio is less than 1.0.<br />
By setting the background color to black or similar and changing the blend ratio, fade-in/out can be achieved.<br />
Naturally, fade-in/out with the target mixing layer is also possible.<br />
The blend ratio and layer position for the target mixing layer use the layer's information.<br />
That is, the display position depends on the layer's position and the blend ratio depends on the layer's opacity.<br />
However, due to the specification that blending with the layer must be specified every time, performing a fade-in/out with a layer will increase CPU load.<br />
</p>

<br />
<br />

<div class="title_bar"><a name="seek_to_keyframe">Keyframes and Seeking</a></div>
<p>In Kirikiri, to perform seeking quickly, seekable positions are limited to keyframes.<br />
If a frame other than a keyframe is specified, a seek operation to the keyframe closest to the specified frame is performed.<br />
However, since this behavior depends on the Codec, unintended behavior often occurs.<br />
Therefore, it is better to always set a keyframe at the frame where you intend to seek.<br />
</p>

<br />
<br />



<br />
</div>
</div>

</body>
</html>