<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<!-- generated by to_html.pl from simple.xml -->
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Basic Usage</title>
	<meta name="author" content="W.Dee" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<meta http-equiv="Content-Script-Type" content="text/javascript" />
	<link href="browser.css" type="text/css" rel="stylesheet" title="Standard Style for Kirikiri-related Reference" />
	<link href="mailto:dee@kikyou.info" rev="Made" />
	<link href="index.html" target="_top" rel="Start" title="Top Page" />
</head>
<body>
<h1><a id="id320" name="id320">Compilation</a>
</h1><div class="para"><div>
　Compilation can be performed with Borland C++ 5.5 or later (C++ Builder 5 or later).<br />
<br />
　Compilation requires regex++ from boost.org.<br />
<br />
　After installing regex++, please compile each cpp file.<br />
<br />
　In the case of C++ Builder, it is sufficient to simply add all the tjs2 cpp files to the project.<br />
<br />
　It can also be compiled with gcc 3 or later (it can also be compiled with 2.95, but fixes related to wstring are required).<br />
</div></div>
<h1><a id="id321" name="id321">Simple Example</a>
</h1><div class="para"><div>
<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>#include&nbsp;&lt;stdio.h&gt;<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>#include&nbsp;&quot;tjs.h&quot;<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>#include&nbsp;&quot;tjsError.h&quot;<br />
<span class="linenumber">&nbsp;&nbsp;4|</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>int&nbsp;main(int&nbsp;argc,&nbsp;char*&nbsp;argv[])<br />
<span class="linenumber">&nbsp;&nbsp;6|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;setlocale(LC_ALL,&nbsp;&quot;&quot;);&nbsp;<span class="comment">//&nbsp;Set&nbsp;locale</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span><br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;tTJS&nbsp;*tjsengine&nbsp;=&nbsp;new&nbsp;tTJS();&nbsp;<span class="comment">//&nbsp;Create&nbsp;TJS2&nbsp;script&nbsp;engine</span><br />
<span class="linenumber">&nbsp;10|</span><br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;try<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;result;&nbsp;<span class="comment">//&nbsp;Variable&nbsp;to&nbsp;receive&nbsp;result</span><br />
<span class="linenumber">&nbsp;14|</span><br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;ExecScript(<br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_W(<br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;function&nbsp;test(x,&nbsp;y)&nbsp;{&nbsp;return&nbsp;x*y;&nbsp;}&nbsp;\n&quot;<br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;return&nbsp;test(4,&nbsp;5);\n&quot;),<br />
<span class="linenumber">&nbsp;19|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;result,&nbsp;NULL,<br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_W(&quot;test&nbsp;code&quot;));&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Execute&nbsp;test&nbsp;script</span><br />
<span class="linenumber">&nbsp;21|</span><br />
<span class="linenumber">&nbsp;22|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Result&nbsp;:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;Display&nbsp;result</span><br />
<span class="linenumber">&nbsp;23|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;24|</span>&nbsp;&nbsp;&nbsp;&nbsp;catch(eTJSError&nbsp;&amp;e)<br />
<span class="linenumber">&nbsp;25|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;26|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;An&nbsp;error&nbsp;occurred&nbsp;:&nbsp;%ls\n&quot;,&nbsp;e.GetMessage().c_str());<br />
<span class="linenumber">&nbsp;27|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;28|</span>&nbsp;&nbsp;&nbsp;&nbsp;catch(...)<br />
<span class="linenumber">&nbsp;29|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;30|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;An&nbsp;error&nbsp;occurred\n&quot;);<br />
<span class="linenumber">&nbsp;31|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;32|</span><br />
<span class="linenumber">&nbsp;33|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;Shutdown();&nbsp;<span class="comment">//&nbsp;Shutdown&nbsp;TJS2&nbsp;script&nbsp;engine</span><br />
<span class="linenumber">&nbsp;34|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;Release();&nbsp;<span class="comment">//&nbsp;Release&nbsp;TJS2&nbsp;script&nbsp;engine</span><br />
<span class="linenumber">&nbsp;35|</span><br />
<span class="linenumber">&nbsp;36|</span>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br />
<span class="linenumber">&nbsp;37|</span>}<br />
</code>
<br />

<br />
<dl>
<dt>Lines 2-3</dt>
<dd>Necessary header files to use TJS2 are being loaded. tjsError.h contains declarations related to TJS C++ exceptions.</dd>


<dt>Line 7</dt>
<dd>The locale is specified with setlocale. If the locale is not specified, it defaults to the "C" locale, which prevents proper conversion between narrow and wide characters for Japanese text.</dd>


<dt>Line 9</dt>
<dd>The TJS2 script engine is created using the new operator.</dd>


<dt>Line 11</dt>
<dd>Entering a try block. Since TJS2 errors are notified through exceptions, care must be taken with exception handling.</dd>


<dt>Line 13</dt>
<dd>Declaring a variable of type tTJSVariant to receive the result of script execution.</dd>


<dt>Lines 15-20</dt>
<dd>Executing the script using tTJS::ExecScript.<br />
The first argument specifies the script to be executed. To pass it as tjs_char*, string literals are converted to wide strings using the TJS_W macro. In the script, function 'test' is defined, and the result of calling that function is returned.<br />
In this example, the result of execution is returned via a return statement and received by the 'result' variable, but if the result does not need to be received, neither the return statement nor the second argument of tTJS::ExecScript is necessary (in that case, specify NULL for the second argument).<br />
The third argument of tTJS::ExecScript is the execution context, but here NULL is specified. If NULL is specified, the script executes on the global context.<br />
The fourth argument of tTJS::ExecScript specifies the name of this script. If NULL, it is treated as anonymous. It should be a human-readable name.</dd>


<dt>Line 22</dt>
<dd>Displaying the result. Here, tTJSVariant is cast to int.</dd>


<dt>Line 24</dt>
<dd>Catching an exception of type eTJSError.</dd>


<dt>Line 26</dt>
<dd>Using eTJSError::GetMessage to display the reason for the exception. tTJSString::c_str is used to convert the message to const tjs_char*. Since tjs_char is a wide character, %ls is specified as the printf format specifier.</dd>


<dt>Line 28</dt>
<dd>Catching other exceptions.</dd>


<dt>Lines 33-34</dt>
<dd>Releasing the TJS2 script engine. Prior to release, tTJS::Shutdown is used to shut down the TJS2 script engine.</dd></dl></div></div>

<h1><a id="id322" name="id322">Calling TJS2 side functions</a>
</h1><div class="para"><div>
　This is how to call a function declared on the TJS2 side from C++.<br />
　Try writing the content within the aforementioned try block as follows.<br />
<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;result;&nbsp;<span class="comment">//&nbsp;Variable&nbsp;to&nbsp;receive&nbsp;result</span><br />
<span class="linenumber">&nbsp;&nbsp;2|</span><br />
<span class="linenumber">&nbsp;&nbsp;3|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;ExecScript(<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_W(&quot;function&nbsp;test(x,&nbsp;y)&nbsp;{&nbsp;return&nbsp;x*y;&nbsp;}&quot;),&nbsp;NULL,&nbsp;NULL,&nbsp;TJS_W(&quot;test&quot;));<br />
<span class="linenumber">&nbsp;&nbsp;5|</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;EvalExpression(TJS_W(&quot;test(4,&nbsp;5)&quot;),&nbsp;&amp;result,&nbsp;NULL,&nbsp;NULL);<br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Execute&nbsp;expression&nbsp;using&nbsp;tTJS::EvalExpression</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span><br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Result&nbsp;:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;Display&nbsp;result</span><br />
<span class="linenumber">&nbsp;10|</span><br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*&nbsp;global&nbsp;=&nbsp;tjsengine-&gt;GetGlobalNoAddRef();<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Get&nbsp;global&nbsp;object</span><br />
<span class="linenumber">&nbsp;13|</span><br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;param[]&nbsp;=&nbsp;{&nbsp;4,&nbsp;5&nbsp;};&nbsp;<span class="comment">//&nbsp;Variables&nbsp;to&nbsp;pass&nbsp;as&nbsp;parameters</span><br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;*p_param[]&nbsp;=&nbsp;{&nbsp;param&nbsp;+&nbsp;0,&nbsp;param&nbsp;+&nbsp;1&nbsp;};&nbsp;<span class="comment">//&nbsp;Array&nbsp;of&nbsp;pointers&nbsp;to&nbsp;variables</span><br />
<span class="linenumber">&nbsp;16|</span><br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_THROW_IF_ERROR(global-&gt;FuncCall(0,&nbsp;TJS_W(&quot;test&quot;),&nbsp;NULL,&nbsp;&amp;result,&nbsp;2,&nbsp;p_param,&nbsp;NULL));<br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Call&nbsp;test&nbsp;as&nbsp;a&nbsp;function</span><br />
<span class="linenumber">&nbsp;19|</span><br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Result&nbsp;:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;Display&nbsp;result</span><br />
</code>
<br />

<br />
<dl>
<dt>Lines 3-4</dt>
<dd>Declaring the function 'test'. 'test' is registered in global.</dd>


<dt>Line 6</dt>
<dd>Executing an expression using tTJS::EvalExpression. If performance is not extremely critical, it is easy to pass the expression as a string and receive the result like this.<br />
Incidentally, for simple expressions (those that do not include other execution units like function declarations), the compilation results are cached to some extent, allowing subsequent expression evaluations to be performed quickly.</dd>


<dt>Line 11</dt>
<dd>Getting the global object. The difference between tTJS::GetGlobal and tTJS::GetGlobalNoAddRef is that the former increments the reference counter of the global object, while the latter does not.<br />
Incrementing the reference counter and decrementing it when finished means placing a lock so that the object does not disappear during that time. If there is no concern about the global object disappearing, as in this example, there is no need to manipulate the reference counter, so tTJS::GetGlobalNoAddRef can be used. Furthermore, in this case, Release is not necessary when finished.</dd>


<dt>Lines 14-15</dt>
<dd>Preparing parameters to pass to the function. iTJSDispatch::FuncCall requires an array of pointers to tTJSVariant types as parameters to be passed to the function, so this preparation is necessary.</dd>


<dt>Line 17</dt>
<dd>Calling the function "test" using iTJSDispatch2::FuncCall.<br />
The last argument of FuncCall is the 'this' (execution context) passed to the function 'test', but since 'this' is not used within the 'test' declared in this example, you may specify NULL. If there is a context to be executed, that object must be specified.<br />
TJS_THROW_IF_ERROR is a macro that throws an exception along with the corresponding error message if the tjs_error result indicates an error.</dd></dl></div></div>

<h1><a id="id323" name="id323">Native Functions</a>
</h1><div class="para"><div>
　You can create a native implementation (functions implemented in C++, etc.) and access it from the TJS2 side.<br />
　Even if it is not C++, as long as it is a language that can implement iTJSDispatch2, functions written in any language can be called, but C++ is likely the easiest.<br />
<br />
　When writing a function in C++, it is easiest to derive a class from tTJSNativeFunction (described in tjsNative.h) (however, it can operate as a function just by implementing FuncCall of iTJSDispatch2).<br />
<br />
　Let's implement a simple function that multiplies two given arguments and returns the result.<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>class&nbsp;TestFunc&nbsp;:&nbsp;public&nbsp;tTJSNativeFunction<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>public:<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_error&nbsp;Process(tTJSVariant&nbsp;*result,&nbsp;tjs_int&nbsp;numparams,<br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;**param,&nbsp;iTJSDispatch2&nbsp;*objthis)<br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(numparams&nbsp;&lt;&nbsp;2)&nbsp;return&nbsp;TJS_E_BADPARAMCOUNT;&nbsp;<span class="comment">//&nbsp;Not&nbsp;enough&nbsp;arguments</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span><br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!result)&nbsp;return&nbsp;TJS_S_OK;&nbsp;<span class="comment">//&nbsp;If&nbsp;result&nbsp;storage&nbsp;is&nbsp;not&nbsp;needed,&nbsp;return&nbsp;as&nbsp;is</span><br />
<span class="linenumber">&nbsp;10|</span><br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*result&nbsp;=&nbsp;*param[0]&nbsp;*&nbsp;*param[1];&nbsp;<span class="comment">//&nbsp;Calculation</span><br />
<span class="linenumber">&nbsp;12|</span><br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;&nbsp;<span class="comment">//&nbsp;Return&nbsp;TJS_S_OK&nbsp;to&nbsp;indicate&nbsp;normal&nbsp;completion</span><br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;15|</span>};<br />
</code>
<br />

<br />
　In a class inheriting from tTJSNativeFunction, only the Process method needs to be implemented, as shown above.<br />
　The arguments for the Process method are as follows:<br />
<br />
<dl>
<dt>tTJSVariant *result</dt>
<dd>　A pointer to a tTJSVariant type variable for storing the function result is passed. <em>Note that NULL is passed if the caller does not require a result</em>.</dd>


<dt>tjs_int numparams</dt>
<dd>　The number of arguments passed to the function.</dd>


<dt>tTJSVariant **param</dt>
<dd>　An array of pointers to tTJSVariant type variables where the arguments passed to the function are stored.</dd>


<dt>iTJSDispatch2 *objthis</dt>
<dd>　The context in which the function should be executed. This can be ignored if the implementation is context-independent.</dd></dl><br />
<br />
<br />
　Native functions must be registered in an object accessible from within TJS2 to make them accessible from TJS2. In the following example, it is registered in global under the name "test". Also, the function is actually called.<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*&nbsp;global&nbsp;=&nbsp;tjsengine-&gt;GetGlobalNoAddRef();<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Get&nbsp;global&nbsp;object</span><br />
<span class="linenumber">&nbsp;&nbsp;3|</span><br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*func&nbsp;=&nbsp;new&nbsp;TestFunc();&nbsp;<span class="comment">//&nbsp;Create&nbsp;TestFunc&nbsp;object</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;func_var(func);&nbsp;<span class="comment">//&nbsp;Set&nbsp;object&nbsp;to&nbsp;tTJSVariant&nbsp;type&nbsp;func_var</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func-&gt;Release();&nbsp;<span class="comment">//&nbsp;Release&nbsp;func</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_THROW_IF_ERROR(<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global-&gt;PropSet(TJS_MEMBERENSURE,&nbsp;TJS_W(&quot;test&quot;),&nbsp;NULL,&nbsp;&amp;func_var,&nbsp;NULL));<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Register</span><br />
<span class="linenumber">&nbsp;11|</span><br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;result;&nbsp;<span class="comment">//&nbsp;Variable&nbsp;to&nbsp;receive&nbsp;result</span><br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;EvalExpression(TJS_W(&quot;test(4,&nbsp;5)&quot;),&nbsp;&amp;result,&nbsp;NULL,&nbsp;NULL);<br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Execute&nbsp;expression&nbsp;using&nbsp;tTJS::EvalExpression</span><br />
<span class="linenumber">&nbsp;15|</span><br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Result&nbsp;:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;Display&nbsp;result</span><br />
</code>
<br />

<br />
<dl>
<dt>Lines 4-6</dt>
<dd>　An object of class TestFunc, which implements the native function, is created and converted to tTJSVariant type.<br />
　It is converted to tTJSVariant type in line 5, and since tTJSVariant automatically manages the reference counter of the function object at this point, the function object is Released in line 6.</dd>


<dt>Lines 8-9</dt>
<dd>　Registering the function under the name "test" in the global object. iTJSDispatch2::PropSet of the global object is called, but it is called with the TJS_MEMBERENSURE flag to cause a new member to be created.</dd>


<dt>Lines 12-16</dt>
<dd>　Actually calling the function and displaying the result.</dd></dl></div></div>
<h1><a id="id324" name="id324">Native Classes</a>
</h1><div class="para"><div>
　TJS2 has a mechanism for handling native classes written in languages like C++.<br />
　Each object (iTJSDispatch2 interface) can have an object of type iTJSNativeInstance, called a native instance, registered to it, and this can be retrieved from the object.<br />
　Native instances are identified by a unique Class ID, and it is necessary to obtain a Class ID when creating a native class.<br />
<br />
　However, since a set of macros for performing these operations is defined in tjsNative.h, it is easier to use them.<br />
　The following example implements a simple class using these macros.<br />
<br />
　First is the implementation of the native instance. To implement a native instance, derive a class from tTJSNativeInstance. tTJSNativeInstance is a class implemented in tjsNative.cpp / tjsNative.h that implements the basic behavior of iTJSNativeInstance.<br />
<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>class&nbsp;NI_Test&nbsp;:&nbsp;public&nbsp;tTJSNativeInstance&nbsp;<span class="comment">//&nbsp;Native&nbsp;instance</span><br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>public:<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;NI_Test()<br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Constructor</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;=&nbsp;0;<br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;&nbsp;9|</span><br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_error&nbsp;TJS_INTF_METHOD<br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Construct(tjs_int&nbsp;numparams,&nbsp;tTJSVariant&nbsp;**param,&nbsp;iTJSDispatch2&nbsp;*tjs_obj)<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Called&nbsp;when&nbsp;a&nbsp;TJS2&nbsp;object&nbsp;is&nbsp;created</span><br />
<span class="linenumber">&nbsp;14|</span><br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;If&nbsp;there&nbsp;are&nbsp;arguments,&nbsp;use&nbsp;them&nbsp;as&nbsp;the&nbsp;initial&nbsp;value&nbsp;for&nbsp;Value</span><br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(numparams&nbsp;&gt;=&nbsp;1&nbsp;&amp;&amp;&nbsp;param[0]-&gt;Type()&nbsp;!=&nbsp;tvtVoid)<br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;=&nbsp;(tjs_int)*param[0];<br />
<span class="linenumber">&nbsp;18|</span><br />
<span class="linenumber">&nbsp;19|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;S_OK;<br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;21|</span><br />
<span class="linenumber">&nbsp;22|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;TJS_INTF_METHOD&nbsp;Invalidate()<br />
<span class="linenumber">&nbsp;23|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;24|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Called&nbsp;when&nbsp;the&nbsp;object&nbsp;is&nbsp;invalidated</span><br />
<span class="linenumber">&nbsp;25|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;26|</span><br />
<span class="linenumber">&nbsp;27|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;SetValue(tjs_int&nbsp;n)&nbsp;{&nbsp;Value&nbsp;=&nbsp;n;&nbsp;}<br />
<span class="linenumber">&nbsp;28|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_int&nbsp;GetValue()&nbsp;const&nbsp;{&nbsp;return&nbsp;Value;&nbsp;}<br />
<span class="linenumber">&nbsp;29|</span><br />
<span class="linenumber">&nbsp;30|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_int&nbsp;GetSquare()&nbsp;const&nbsp;{&nbsp;return&nbsp;Value*Value;&nbsp;}<br />
<span class="linenumber">&nbsp;31|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;Add(tjs_int&nbsp;n)&nbsp;{&nbsp;Value&nbsp;+=&nbsp;n;&nbsp;}<br />
<span class="linenumber">&nbsp;32|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;Print()&nbsp;const&nbsp;{&nbsp;printf(&quot;%d\n&quot;,&nbsp;Value);&nbsp;}<br />
<span class="linenumber">&nbsp;33|</span><br />
<span class="linenumber">&nbsp;34|</span>private:<br />
<span class="linenumber">&nbsp;35|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_int&nbsp;Value;&nbsp;<span class="comment">//&nbsp;Value</span><br />
<span class="linenumber">&nbsp;36|</span>};<br />
</code>
<br />

<br />
<dl>
<dt>Line 35</dt>
<dd>　A bit out of order, but this is a data member. You can freely write any necessary data members in a native instance.</dd>

<dt>Lines 4-8</dt>
<dd>　Constructor for NI_Test. We recommend performing C++ class initialization here rather than in the Construct method mentioned later, keeping initialization in Construct to a minimum.<br />
　In this example, the data member Value is initialized to 0.</dd>


<dt>Lines 10-20</dt>
<dd>　Called when a TJS2 object is created using the new operator. The numparams and param arguments represent the arguments passed to the new operator.<br />
　The tjs_obj argument is the TJS object being created.<br />
　In this example, if arguments are present (and not void), they are set as the initial value of Value.</dd>


<dt>Lines 22-25</dt>
<dd>　A method called when the object is invalidated. It is a good place to write cleanup logic.<br />
　This example does nothing.</dd>


<dt>Lines 27-32</dt>
<dd>　A set of public methods for manipulating data members. Code utilizing these will be written in the native class described later.</dd></dl><br />
　Since a class is needed to create objects, we define a class. The class is implemented by deriving from tTJSNativeClass. tTJSNativeClass has an iTJSDispatch2 interface and implements basic behavior to act as a native class.<br />
　Methods and properties accessible from TJS are described within the native class's constructor.<br />
<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>class&nbsp;NC_Test&nbsp;:&nbsp;public&nbsp;tTJSNativeClass&nbsp;<span class="comment">//&nbsp;Native&nbsp;class</span><br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>public:<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;NC_Test();&nbsp;<span class="comment">//&nbsp;Constructor;&nbsp;described&nbsp;below</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;tjs_uint32&nbsp;ClassID;&nbsp;<span class="comment">//&nbsp;Class&nbsp;ID</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span>private:<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;tTJSNativeInstance&nbsp;*CreateNativeInstance()<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;NI_Test();&nbsp;<span class="comment">//&nbsp;Create&nbsp;and&nbsp;return&nbsp;native&nbsp;instance</span><br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;13|</span>};<br />
<span class="linenumber">&nbsp;14|</span>tjs_uint32&nbsp;NC_Test::ClassID&nbsp;=&nbsp;(tjs_uint32)-1;&nbsp;<span class="comment">//&nbsp;Class&nbsp;ID</span><br />
</code>
<br />

<br />
<dl>
<dt>Line 4</dt>
<dd>　Constructor for this class. Its implementation is described below.</dd>


<dt>Line 6</dt>
<dd>　A variable to hold the Class ID of this class. Its entity is at line 14.</dd>


<dt>Lines 9-12</dt>
<dd>　The CreateNativeInstance method is called when a native instance should be created. Here, it creates and returns an object of the NI_Test class.</dd></dl><br />
<br />
<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>NC_Test::NC_Test()&nbsp;:&nbsp;tTJSNativeClass(TJS_W(&quot;Test&quot;))<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_MEMBERS(<span class="comment">/*TJS&nbsp;class&nbsp;name*/</span>Test)<br />
<span class="linenumber">&nbsp;&nbsp;4|</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_DECL_EMPTY_FINALIZE_METHOD<br />
<span class="linenumber">&nbsp;&nbsp;6|</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_CONSTRUCTOR_DECL(<br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.name*/</span>_this,<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.type*/</span>NI_Test,<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*TJS&nbsp;class&nbsp;name*/</span>Test)<br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Since&nbsp;details&nbsp;can&nbsp;also&nbsp;be&nbsp;described&nbsp;in&nbsp;NI_Test::Construct</span><br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;we&nbsp;do&nbsp;nothing&nbsp;here</span><br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_CONSTRUCTOR_DECL(<span class="comment">/*TJS&nbsp;class&nbsp;name*/</span>Test)<br />
<span class="linenumber">&nbsp;17|</span><br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_METHOD_DECL(<span class="comment">/*func.&nbsp;name*/</span>print)&nbsp;<span class="comment">//&nbsp;print&nbsp;method</span><br />
<span class="linenumber">&nbsp;19|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;21|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;22|</span><br />
<span class="linenumber">&nbsp;23|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_this-&gt;Print();<br />
<span class="linenumber">&nbsp;24|</span><br />
<span class="linenumber">&nbsp;25|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;26|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;27|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_METHOD_DECL(<span class="comment">/*func.&nbsp;name*/</span>print)<br />
<span class="linenumber">&nbsp;28|</span><br />
<span class="linenumber">&nbsp;29|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_METHOD_DECL(<span class="comment">/*func.&nbsp;name*/</span>add)&nbsp;<span class="comment">//&nbsp;add&nbsp;method</span><br />
<span class="linenumber">&nbsp;30|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;31|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;32|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;33|</span><br />
<span class="linenumber">&nbsp;34|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(numparams&nbsp;&lt;&nbsp;1)&nbsp;return&nbsp;TJS_E_BADPARAMCOUNT;<br />
<span class="linenumber">&nbsp;35|</span><br />
<span class="linenumber">&nbsp;36|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_this-&gt;Add((tjs_int)*param[0]);<br />
<span class="linenumber">&nbsp;37|</span><br />
<span class="linenumber">&nbsp;38|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;39|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;40|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_METHOD_DECL(<span class="comment">/*func.&nbsp;name*/</span>add)<br />
<span class="linenumber">&nbsp;41|</span><br />
<span class="linenumber">&nbsp;42|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_DECL(value)&nbsp;<span class="comment">//&nbsp;value&nbsp;property</span><br />
<span class="linenumber">&nbsp;43|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;44|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;45|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;46|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;47|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;48|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*result&nbsp;=&nbsp;_this-&gt;GetValue();<br />
<span class="linenumber">&nbsp;49|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;50|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;51|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;52|</span><br />
<span class="linenumber">&nbsp;53|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_SETTER<br />
<span class="linenumber">&nbsp;54|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;55|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;56|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;57|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_this-&gt;SetValue((tjs_int)*param);<br />
<span class="linenumber">&nbsp;58|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;59|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;60|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_SETTER<br />
<span class="linenumber">&nbsp;61|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;62|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_DECL(value)<br />
<span class="linenumber">&nbsp;63|</span><br />
<span class="linenumber">&nbsp;64|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_DECL(square)&nbsp;<span class="comment">//&nbsp;square&nbsp;read-only&nbsp;property</span><br />
<span class="linenumber">&nbsp;65|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;66|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;67|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;68|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;69|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;70|</span><br />
<span class="linenumber">&nbsp;71|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*result&nbsp;=&nbsp;_this-&gt;GetSquare();<br />
<span class="linenumber">&nbsp;72|</span><br />
<span class="linenumber">&nbsp;73|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;74|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;75|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;76|</span><br />
<span class="linenumber">&nbsp;77|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_DENY_NATIVE_PROP_SETTER<br />
<span class="linenumber">&nbsp;78|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;79|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_DECL(square)<br />
<span class="linenumber">&nbsp;80|</span><br />
<span class="linenumber">&nbsp;81|</span>&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_MEMBERS<br />
<span class="linenumber">&nbsp;82|</span>}<br />
</code>
<br />

<br />
<dl>
<dt>Line 1</dt>
<dd>　Constructor for NC_Test. Specify the class name to be used within TJS2 in the constructor of the parent class tTJSNativeClass.</dd>


<dt>Line 3</dt>
<dd>　The TJS_BEGIN_NATIVE_MEMBERS macro. Specify the class name used within TJS2 as the argument.<br />
　Place descriptions of methods and properties that should be members of the class between this macro and the TJS_END_NATIVE_MEMBERS macro.</dd>


<dt>Line 4</dt>
<dd>　Declaring an empty finalize method. Since processing equivalent to finalize can also be implemented by overriding tTJSNativeInstance::Invalidate, an empty method is usually sufficient.
</dd>


<dt>Lines 7-16</dt>
<dd>　Declaring the (TJS) constructor. This corresponds to the part in a TJS class where a method with the same name as the class is declared.<br />
<br />
　The first argument of the TJS_BEGIN_NATIVE_CONSTRUCTOR_DECL macro is the variable name assigned to the native instance, and the second is the type name of that variable. Within this block in this example, a variable NI_Test * _this is available, allowing access to the native instance.<br />
　The third argument of the macro specifies the class name to be used within TJS. The argument for the TJS_END_NATIVE_CONSTRUCTOR_DECL macro is the same.<br />
　Since processing equivalent to the constructor can be implemented by overriding tTJSNativeInstance::Construct, we simply return S_OK here without doing anything.
</dd>


<dt>Lines 18-27</dt>
<dd>　Declaring the print method. The same method name must be specified in both TJS_BEGIN_NATIVE_METHOD_DECL and TJS_END_NATIVE_METHOD_DECL macros.<br />
　Within this macro, variables tjs_int numparams and tTJSVariant **param are available, indicating the number of arguments and the arguments themselves. This method does not use them.<br />
　Lines 20-21 show a macro for retrieving the native instance from the object. In this example, it means retrieving the native instance into a variable named _this of type NI_Test *. Henceforth, you can access the native instance using the variable _this. Line 23 calls the Print method of that native instance.</dd>


<dt>Lines 29-40</dt>
<dd>　Declaring the add method. Here, numparams and param are used.</dd>



<dt>Lines 42-62</dt>
<dd>　Declaring the value property. Specify the property name in both TJS_BEGIN_NATIVE_PROP_DECL and TJS_END_NATIVE_PROP_DECL macros, just like with method declarations.<br />
<br />
　Getters can be written in the space enclosed by the TJS_BEGIN_NATIVE_PROP_GETTER and TJS_END_NATIVE_PROP_GETTER macros. In the getter, write to set the value in *result, which is of type tTJSVariant.<br />
　Similarly, setters can be written between the TJS_BEGIN_NATIVE_PROP_SETTER and TJS_END_NATIVE_PROP_SETTER macros. In the setter, the value to be set is stored in *param of type tTJSVariant, so use that for processing.</dd>


<dt>Lines 64-79</dt>
<dd>　Declaring a read-only property here. You can create a read-only property by writing TJS_DENY_NATIVE_PROP_SETTER instead of a setter.</dd></dl><br />
<br />
<br />
　Registering a native class is the same as registering a native function. An example of test code is shown below.<br />
<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*&nbsp;global&nbsp;=&nbsp;tjsengine-&gt;GetGlobalNoAddRef();<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Get&nbsp;global&nbsp;object</span><br />
<span class="linenumber">&nbsp;&nbsp;3|</span><br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*cls&nbsp;=&nbsp;new&nbsp;NC_Test();&nbsp;<span class="comment">//&nbsp;Create&nbsp;NC_Test&nbsp;object</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;cls_var(cls);&nbsp;<span class="comment">//&nbsp;Set&nbsp;object&nbsp;to&nbsp;tTJSVariant&nbsp;type&nbsp;cls_var</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cls-&gt;Release();&nbsp;<span class="comment">//&nbsp;Release&nbsp;cls</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_THROW_IF_ERROR(<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global-&gt;PropSet(TJS_MEMBERENSURE,&nbsp;TJS_W(&quot;Test&quot;),&nbsp;NULL,&nbsp;&amp;cls_var,&nbsp;NULL));<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Register</span><br />
<span class="linenumber">&nbsp;11|</span><br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;ExecScript(TJS_W(<br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;var&nbsp;test&nbsp;=&nbsp;new&nbsp;Test();\n&quot;<br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;test.value&nbsp;=&nbsp;5;\n&quot;<br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;var&nbsp;test2&nbsp;=&nbsp;new&nbsp;Test(test.square);\n&quot;<br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;test2.add(3);\n&quot;<br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;test2.print();\n\0&quot;),<br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;NULL,&nbsp;NULL);&nbsp;<span class="comment">//&nbsp;Execute&nbsp;script</span><br />
</code>
<br />

<br />
</div></div>
	<script type="text/javascript" charset="UTF-8" src="documentid.js" ></script>
	<script type="text/javascript" charset="UTF-8" src="postcontent.js" ></script>
</body>
</html>